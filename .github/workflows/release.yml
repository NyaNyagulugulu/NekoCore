name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Set up JDK 8
      uses: actions/setup-java@v3
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    # Configure git for proper line endings
    - name: Configure Git
      run: |
        git config --global core.autocrlf false
        git config --global core.eol lf

    # Build Minecraft server dependency using BuildTools
    - name: Build and install Minecraft server dependency
      run: |
        echo "Building Minecraft server dependency with BuildTools..."
        
        # Accept EULA
        mkdir -p eula-accept
        cd eula-accept
        echo "#By changing the setting below to TRUE you are indicating your agreement to our EULA (https://account.mojang.com/documents/minecraft_eula)." > eula.txt
        echo "#$(date)" >> eula.txt
        echo "eula=true" >> eula.txt
        cd ..
        
        # Download and run BuildTools
        mkdir -p buildtools
        cd buildtools
        
        # Download BuildTools
        wget https://hub.spigotmc.org/jenkins/job/BuildTools/lastSuccessfulBuild/artifact/target/BuildTools.jar
        
        if [ -f "BuildTools.jar" ]; then
          echo "BuildTools downloaded successfully"
          # Run BuildTools to build the required dependencies
          java -jar BuildTools.jar --rev 1.12.2 --disable-java-check
          
          # Install the built server jar to local repository
          if [ -f "CraftBukkit/target/craftbukkit-1.12.2-R0.1-SNAPSHOT.jar" ]; then
            echo "Installing CraftBukkit to local repository..."
            mvn install:install-file \
              -Dfile=CraftBukkit/target/craftbukkit-1.12.2-R0.1-SNAPSHOT.jar \
              -DgroupId=org.spigotmc \
              -DartifactId=minecraft-server \
              -Dversion=1.12.2-SNAPSHOT \
              -Dpackaging=jar
            echo "Minecraft server dependency installed successfully"
          else
            echo "ERROR: Could not find built server jar"
            find . -name "*.jar" -type f
            exit 1
          fi
        else
          echo "ERROR: Could not download BuildTools.jar"
          exit 1
        fi
        
        cd ..

    # Build and install parent POM
    - name: Build and install parent POM
      run: |
        echo "Building and installing parent POM..."
        mvn clean install -N -DskipTests=true -Dmaven.javadoc.skip=true -B -e -U

    # Build Paper-API
    - name: Build Paper-API
      run: |
        echo "Building Paper-API..."
        mvn clean install -pl Paper-API -DskipTests=true -Dmaven.javadoc.skip=true -B -e -U

    # Build entire project
    - name: Build entire project
      run: |
        echo "Building entire project..."
        mvn clean install -DskipTests=true -Dmaven.javadoc.skip=true -B -e -U

    # Find and prepare JAR files for release
    - name: Find and prepare JAR files for release
      id: find_jars
      run: |
        echo "Searching for JAR files to release..."
        # Look for the main JAR files
        SERVER_JAR=$(find ./Neko-Server/target -name "paper-1.12.2.jar" -type f | head -1)
        API_JAR=$(find ./Paper-API/target -name "paper-api-1.12.2-R0.1-SNAPSHOT.jar" -type f | head -1)
        SHADED_API_JAR=$(find ./Paper-API/target -name "paper-api-1.12.2-R0.1-SNAPSHOT-shaded.jar" -type f | head -1)
        
        # Create directory for release files
        mkdir -p release-files
        
        # Copy files to release directory
        if [ -n "$SERVER_JAR" ] && [ -f "$SERVER_JAR" ]; then
          cp "$SERVER_JAR" release-files/
          echo "Copied server JAR: $SERVER_JAR"
        fi
        
        if [ -n "$API_JAR" ] && [ -f "$API_JAR" ]; then
          cp "$API_JAR" release-files/
          echo "Copied API JAR: $API_JAR"
        fi
        
        if [ -n "$SHADED_API_JAR" ] && [ -f "$SHADED_API_JAR" ]; then
          cp "$SHADED_API_JAR" release-files/
          echo "Copied shaded API JAR: $SHADED_API_JAR"
        fi
        
        # Output list of files for release
        FILES_TO_RELEASE=""
        if ls release-files/*.jar 1> /dev/null 2>&1; then
          FILES_TO_RELEASE=$(ls release-files/*.jar | tr '\n' ' ')
        fi
        
        echo "files=$FILES_TO_RELEASE" >> $GITHUB_OUTPUT
        echo "Found files for release: $FILES_TO_RELEASE"

    - name: Release
      uses: softprops/action-gh-release@v1
      if: steps.find_jars.outputs.files != ''
      with:
        files: ${{ steps.find_jars.outputs.files }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
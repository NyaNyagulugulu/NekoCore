name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Set up JDK 8
      uses: actions/setup-java@v3
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    # 首先构建并安装根POM，这样子模块可以正确引用它
    - name: Build and install parent POM
      run: |
        echo "Building and installing parent POM..."
        # 构建根POM
        mvn clean install -N -DskipTests=true -Dmaven.javadoc.skip=true -B -e -U

    # 然后构建整个多模块项目
    - name: Build entire project
      run: |
        echo "Building entire project..."
        # 构建所有模块
        mvn clean install -DskipTests=true -Dmaven.javadoc.skip=true -B -e -U

    # 查找构建产生的JAR文件并准备发布
    - name: Find and prepare JAR files for release
      id: find_jars
      run: |
        echo "Searching for JAR files to release..."
        # 查找主要的JAR文件
        SERVER_JAR=$(find ./Neko-Server/target -name "paper-1.12.2.jar" -type f | head -1)
        API_JAR=$(find ./Paper-API/target -name "paper-api-1.12.2-R0.1-SNAPSHOT.jar" -type f | head -1)
        SHADED_API_JAR=$(find ./Paper-API/target -name "paper-api-1.12.2-R0.1-SNAPSHOT-shaded.jar" -type f | head -1)
        
        # 创建一个临时目录来存放要发布的文件
        mkdir -p release-files
        
        # 复制文件到临时目录
        if [ -n "$SERVER_JAR" ] && [ -f "$SERVER_JAR" ]; then
          cp "$SERVER_JAR" release-files/
          echo "Copied server JAR: $SERVER_JAR"
        fi
        
        if [ -n "$API_JAR" ] && [ -f "$API_JAR" ]; then
          cp "$API_JAR" release-files/
          echo "Copied API JAR: $API_JAR"
        fi
        
        if [ -n "$SHADED_API_JAR" ] && [ -f "$SHADED_API_JAR" ]; then
          cp "$SHADED_API_JAR" release-files/
          echo "Copied shaded API JAR: $SHADED_API_JAR"
        fi
        
        # 列出要发布的文件
        FILES_TO_RELEASE=""
        if ls release-files/*.jar 1> /dev/null 2>&1; then
          FILES_TO_RELEASE=$(ls release-files/*.jar | tr '\n' ' ')
        fi
        
        echo "files=$FILES_TO_RELEASE" >> $GITHUB_OUTPUT
        echo "Found files for release: $FILES_TO_RELEASE"

    - name: Release
      uses: softprops/action-gh-release@v1
      if: steps.find_jars.outputs.files != ''
      with:
        files: ${{ steps.find_jars.outputs.files }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
name: Auto Release

on:
  workflow_dispatch: # 允许手动触发
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Set up JDK 8
      uses: actions/setup-java@v3
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build with Maven
      run: |
        mvn clean install -DskipTests=true -Dmaven.javadoc.skip=true -B -V

    - name: Find JAR artifacts
      id: find_jars
      run: |
        # 在target目录中查找所有jar文件
        JARS=$(find . -name "*.jar" -not -path "./.git/*" -not -path "./.github/*" -not -path "./target/*" | grep -E "(Neko|Server|Paper)" || find . -name "*.jar" -not -path "./.git/*" -not -path "./.github/*")
        echo "Found JAR files:"
        echo "$JARS"
        
        # 输出到GITHUB_OUTPUT供后续步骤使用
        echo "jars<<EOF" >> $GITHUB_OUTPUT
        echo "$JARS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: NekoCore Release ${{ github.ref_name }}
        draft: false
        prerelease: false

    - name: Upload Release Assets
      if: steps.find_jars.outputs.jars != ''
      run: |
        while IFS= read -r jarfile; do
          if [ -f "$jarfile" ]; then
            echo "Uploading $jarfile"
            gh release upload ${{ github.ref_name }} "$jarfile" --clobber
          fi
        done <<< "${{ steps.find_jars.outputs.jars }}"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}